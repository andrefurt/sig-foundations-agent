# rule: Component – Listbox
type: intelligent
scope: **/*
---
## Overview
Short purpose and when-to-use guidance for **Listbox**.

## Anatomy
- Structure and slots (leading/trailing/media/actions/meta if applicable).

## Props (typed)
- List key props with types, defaults, and constraints.

## States
- Hover, focus, active, disabled, loading, invalid.

## Accessibility
- Roles, labels, keyboard, focus outline, ARIA attributes.

## Usage Examples
- Basic usage
- With slots (icon/text/secondary action)
- Edge cases (long text, truncation)

## Do / Don't
- Do: keep API surface small; reuse Foundations tokens.
- Don't: hardcode colors; expose unstable DOM structure.

## Notes
Merged documentation from repository and component docs (if present).

---

### Source Docs
# Listbox

## Visão geral

`Listbox` é um controlo para seleccionar um ou mais valores de uma lista de opções.  Fornece navegação por teclado completa, pesquisa integrada e integração com formulários【601972489212375†L40-L50】.

## Funcionalidades principais

- **Navegação por teclado**: suporta setas para navegar, `Enter` ou `Espaço` para seleccionar e teclas Home/End para saltar para o início ou fim【601972489212375†L42-L47】【601972489212375†L172-L179】.
- **Pesquisa**: campo integrado para filtrar opções【601972489212375†L42-L45】.
- **Selecção múltipla**: permite seleccionar vários valores com checkboxes【601972489212375†L45-L46】.
- **Renderização personalizada**: API flexível para opções customizadas, incluindo avatares ou layout complexo【601972489212375†L47-L48】.
- **Integração com formulários**: trabalha bem com bibliotecas de formulários e validação, permitindo estados inválidos e desactivados【601972489212375†L48-L50】.
- **Acessibilidade**: segue o padrão WAI‑ARIA Listbox, com roles e propriedades apropriadas【601972489212375†L166-L170】.
- **Floating UI**: utiliza `@floating-ui/react` para posicionar a lista em relação ao trigger【601972489212375†L50-L51】.

## Dependências

- `Popover` e `Divider` para estrutura e separação【601972489212375†L5-L13】.
- Estilos de `input` para o campo trigger【601972489212375†L15-L17】.
- Biblioteca `@floating-ui/react` para posicionamento【601972489212375†L19-L21】.

## Anatomia

```tsx
<Listbox value={valor} onChange={setValor}>
  <ListboxTrigger />
  <ListboxOptions>
    <ListboxSearchInput />
    <ListboxOption />
    <ListboxDivider />
    <ListboxOption />
    <ListboxEmpty />
  </ListboxOptions>
</Listbox>
```【601972489212375†L25-L37】

Componentes:

- **Listbox**: elemento raiz que controla estado e renderiza children.
- **ListboxTrigger**: botão que abre a lista; aceita variante visual e placeholder【601972489212375†L107-L116】.
- **ListboxOptions**: contêiner com as opções; renderizado num portal【601972489212375†L120-L125】.
- **ListboxOption**: opção individual; aceita valor, estado desactivado e se mostra um visto【601972489212375†L127-L149】.
- **ListboxDivider**: linha horizontal para separar grupos【601972489212375†L152-L155】.
- **ListboxSearchInput**: input estilizado para filtrar opções【601972489212375†L156-L160】.
- **ListboxEmpty**: mensagem de estado vazio quando não há correspondências【601972489212375†L162-L165】.

## API (Listbox)

| Propriedade | Tipo | Predefinição | Descrição |
| --- | --- | --- | --- |
| **value** | `T` ou `T[]` | – (obrigatório) | Valor seleccionado ou array de valores para múltiplas selecções【601972489212375†L58-L63】. |
| **onChange** | `(valor: T | T[]) => void` | – (obrigatório) | Callback quando o valor muda【601972489212375†L65-L68】. |
| **disabled** | `boolean` | `false` | Desactiva o listbox【601972489212375†L70-L74】. |
| **invalid** | `boolean` | `false` | Indica estado inválido【601972489212375†L76-L79】. |
| **placement** | `'selection'` ou `Placement` | `'selection'` | Define onde posicionar a lista (alinhar com o item seleccionado ou com o trigger)【601972489212375†L81-L86】. |
| **getIsSelected** | `(a: T, b: T) => boolean` | – | Função de comparação personalizada【601972489212375†L87-L91】. |
| **matchReferenceWidth** | `boolean` | `true` | Define se a largura da lista deve corresponder ao trigger【601972489212375†L92-L97】. |

## API (ListboxTrigger)

| Propriedade | Tipo | Predefinição | Descrição |
| --- | --- | --- | --- |
| **variant** | `InputProps['variant']` | `'default'` | Estilo visual do trigger【601972489212375†L107-L111】. |
| **placeholder** | `string` | – | Texto mostrado quando nenhum valor está seleccionado【601972489212375†L112-L116】. |

## API (ListboxOption)

| Propriedade | Tipo | Predefinição | Descrição |
| --- | --- | --- | --- |
| **value** | `T` | – (obrigatório) | Valor associado a esta opção【601972489212375†L133-L137】. |
| **disabled** | `boolean` | `false` | Desactiva a opção【601972489212375†L139-L142】. |
| **withCheckmark** | `boolean` | `true` | Mostra ou esconde o visto quando seleccionado【601972489212375†L143-L148】. |

## Acessibilidade e interacções

O `Listbox` implementa o [padrão WAI‑ARIA Listbox](https://www.w3.org/WAI/ARIA/apg/patterns/listbox/), fornecendo roles adequados e navegação por teclado.  As principais teclas suportadas incluem seta para cima/baixo, `Home`, `End`, `Enter`/`Espaço` para seleccionar, `Escape` para fechar e digitação para saltar para opções começando com determinadas letras【601972489212375†L166-L179】.

## Boas práticas

- **Escolha do componente**: use `Select` quando precisa apenas de uma lista simples; prefira `Listbox` para renderizar itens personalizados, pesquisa, múltipla selecção ou navegação avançada【32041770826828†L114-L119】.
- **Organização**: agrupe opções com `ListboxSection` e use divisores para separar grupos relacionados【601972489212375†L25-L37】.
- **Pesquisa**: adicione a caixa de pesquisa para listas longas; mostre `ListboxEmpty` quando não houver resultados【601972489212375†L166-L170】.
- **Acessibilidade**: garanta que o trigger e a lista têm rótulos claros; disponibilize mensagens de estado para utilizadores de leitores de ecrã.

## Source Snapshot
_Synced from foundations-main (read-only)._

**src/foundations/ui/listbox/listbox.tsx**

```tsx
"use client";

import {
  autoUpdate,
  flip,
  FloatingList,
  offset,
  Placement,
  shift,
  size,
  useClick,
  useDismiss,
  useFloating,
  UseFloatingReturn,
  useInteractions,
  UseInteractionsReturn,
  useListItem,
  useListNavigation,
  useMergeRefs,
  useRole,
  useTypeahead,
} from "@floating-ui/react";
import { CaretUpDownIcon, CheckIcon } from "@phosphor-icons/react";
import { VariantProps } from "cva";
import {
  Children,
  createContext,
  isValidElement,
  use,
  useCallback,
  useEffect,
  useImperativeHandle,
  useMemo,
  useRef,
  useState,
} from "react";

import { Divider } from "@/foundations/ui/divider/divider";
import { inputStyle } from "@/foundations/ui/input/input";
import {
  PopoverEmpty,
  PopoverPanel,
  PopoverSearchInput,
} from "@/foundations/ui/popover/popover";
import { cn } from "@/lib/utils";

// Utils

const hasChildren = (
  props: unknown
): props is { children: React.ReactNode } => {
  return typeof props === "object" && props !== null && "children" in props;
};

export function getTextContent(children: React.ReactNode): string {
  if (typeof children === "string") return children;
  if (typeof children === "number") return children.toString();
  if (Array.isArray(children)) return children.map(getTextContent).join("");
  if (isValidElement(children) && hasChildren(children.props))
    return getTextContent(children.props.children);
  return "";
}

// Context

type Option<T = string> = {
  value: T;
  label: string;
  disabled?: boolean;
};

interface ListboxContextType<T = string>
  extends UseFloatingReturn,
    UseInteractionsReturn {
  elementsRef: React.RefObject<(HTMLElement | null)[]>;
  labelsRef: React.RefObject<string[]>;
  setOptions: (options: Option<T>[]) => void;
  highlightedIndex: number | null;
  setHighlightedIndex: React.Dispatch<React.SetStateAction<number | null>>;
  value: T | undefined;
  handleSelect: (index: number | null) => void;
  invalid?: boolean;
  disabled?: boolean;
  setIsSearchable: React.Dispatch<React.SetStateAction<boolean>>;
  getIsSelected: (a: T, b: T) => boolean;
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const ListboxContext = createContext<ListboxContextType<any> | null>(null);

const useListboxContext = <T,>() => {
  const context = use(
    ListboxContext as React.Context<ListboxContextType<T> | null>
  );

  if (context == null) {
    throw new Error("useListboxContext must be used within a Listbox");
  }

  return context;
};

// Utils

const isObjectWithId = (value: unknown): value is { id: unknown } => {
  return typeof value === "object" && value !== null && "id" in value;
};

const isPrimitive = (value: unknown): value is string | number | boolean => {
  return typeof value !== "object" && value !== null;
};

const defaultGetIsSelected = <T,>(a: T, b: T) => {
  if (isObjectWithId(a) && isObjectWithId(b)) {
    return a.id === b.id;
  }

  if (isPrimitive(a) && isPrimitive(b)) {
    return a === b;
  }

  return JSON.stringify(a) === JSON.stringify(b);
};

// Chore mechanics (Floating UI)

interface UseListboxFloatingOptions<T = string> {
  value: T;
  onChange: (value: T) => void;
  disabled?: boolean;
  invalid?: boolean;
  placement?: Placement;
  getIsSelected?: (a: T, b: T) => boolean;
  matchReferenceWidth?: boolean;
}

const useListboxFloating = <T,>({
  value,
  onChange,
  disabled,
  invalid,
  placement = "bottom",
  getIsSelected = defaultGetIsSelected,
  matchReferenceWidth = true,
}: UseListboxFloatingOptions<T>) => {
  const [open, setOpen] = useState(false);

  const [isSearchable, setIsSearchable] = useState(false);
  const [highlightedIndex, setHighlightedIndex] = useState<number | null>(null);
  const [options, setOptions] = useState<Option<T>[]>([]);

  const elementsRef = useRef<(HTMLElement | null)[]>([]);

  const selectedIndex = useMemo(() => {
    if (!value) return -1;

    return options.findIndex((option) => {
      return getIsSelected(option.value, value);
    });
  }, [options, value, getIsSelected]);

  const floating = useFloating({
    placement,
    open,
    onOpenChange: setOpen,
    whileElementsMounted: (reference, floating, update) =>
      autoUpdate(reference, floating, update, {
        layoutShift: false,
      }),
    middleware: [
      flip({ padding: 4 }),
      shift({ padding: 4 }),
      offset(4),
      size({
        apply({ rects, elements, availableHeight }) {
          elements.floating.style.setProperty(
            "--max-height",
            `${availableHeight}px`
          );

          if (matchReferenceWidth) {
            elements.floating.style.setProperty(
              "--width",
              `${rects.reference.width}px`
            );
          }
        },
        padding: 4,
      }),
    ],
  });

  const handleSelect = useCallback(
    (index: number | null) => {
      if (index === null || !options[index]) return;

      // assuming that a `value` array means a multiselect (sorry tuples)
      const isMultiple = Array.isArray(value);

      if (isMultiple) {
        const isSelected = value.some((v) =>
          getIsSelected(options[index].value, v)
        );

        return isSelected
          ? onChange(
              value.filter((v) => !getIsSelected(options[index].value, v)) as T
            )
          : onChange([...value, options[index].value] as T);
      }

      onChange(options[index].value);
      setOpen(false);
    },
    [onChange, options, value, getIsSelected]
  );

  const listNav = useListNavigation(floating.context, {
    listRef: elementsRef,
    activeIndex: highlightedIndex,
    selectedIndex,
    onNavigate: setHighlightedIndex,
    virtual: isSearchable || undefined,
    loop: isSearchable || undefined,
  });

  const handleTypeaheadMatch = useCallback(
    (index: number | null) => {
      if (open) {
        setHighlightedIndex(index);
      } else {
        handleSelect(index);
      }
    },
    [open, handleSelect]
  );

  const labelsRef = useRef<string[]>([]);

  useEffect(() => {
    labelsRef.current = options.map((option) => option.label);
  }, [options]);

  const typeahead = useTypeahead(floating.context, {
    enabled: !(isSearchable && open),
    listRef: labelsRef,
    activeIndex: highlightedIndex,
    selectedIndex,
    onMatch: handleTypeaheadMatch,
  });

  const click = useClick(floating.context, {
    enabled: !disabled,
    event: "mousedown",
  });
  const dismiss = useDismiss(floating.context);
  const role = useRole(floating.context, { role: "listbox" });

  const interactions = useInteractions([
    listNav,
    typeahead,
    click,
    dismiss,
    role,
  ]);

  return useMemo(
    () => ({
      elementsRef,
      labelsRef,
      highlightedIndex,
      setHighlightedIndex,
      value,
      invalid,
      disabled,
      setOptions,
      handleSelect,
      setIsSearchable,
      getIsSelected,
      ...interactions,
      ...floating,
    }),
    [
      highlightedIndex,
      value,
      invalid,
      disabled,
      setOptions,
      handleSelect,
      getIsSelected,
      interactions,
      floating,
    ]
  );
};

// Components

type ListboxProps<T = string> = UseListboxFloatingOptions<T> & {
  children: React.ReactNode;
};

/**
 * Listbox is a controlled component used for choosing a value from a list of options, typically in forms.
 * It's best suited for scenarios where users need to pick an item from a predefined set.
 *
 * Use Listbox when choosing a value from a list of options.
 * Use Dropdown instead when you want to trigger actions or navigation.
 */
const Listbox = <T,>({
  children,
  ref,
  ...props
}: ListboxProps<T> & { ref?: React.Ref<ListboxContextType<T>> }) => {
  const contextValue = useListboxFloating(props);

  useImperativeHandle(ref, () => contextValue);

  return <ListboxContext value={contextValue}>{children}</ListboxContext>;
};

interface ListboxTriggerProps extends React.ComponentPropsWithRef<"button"> {
  variant?: VariantProps<typeof inputStyle>["variant"];
  p
// ... truncated ...

```

**src/foundations/ui/listbox/examples/listbox-search.preview.tsx**

```tsx
"use client";

import { useMemo, useState } from "react";

import {
  Listbox,
  ListboxEmpty,
  ListboxOption,
  ListboxOptions,
  ListboxSearchInput,
  ListboxTrigger,
} from "@/foundations/ui/listbox/listbox";

const people = [
  { id: 1, name: "Durward Reynolds" },
  { id: 2, name: "Kenton Towne" },
  { id: 3, name: "Therese Wunsch" },
  { id: 4, name: "Benedict Kessler" },
  { id: 5, name: "Katelyn Rohan" },
];

export default function ListboxSearchPreview() {
  const [search, setSearch] = useState("");
  const [selectedPerson, setSelectedPerson] = useState(people[0]);

  const filteredPeople = useMemo(() => {
    return people.filter((person) =>
      person.name.toLowerCase().includes(search.toLowerCase())
    );
  }, [search]);

  return (
    <div className="w-80">
      <Listbox value={selectedPerson} onChange={setSelectedPerson}>
        <ListboxTrigger>{selectedPerson?.name}</ListboxTrigger>
        <ListboxOptions>
          <ListboxSearchInput
            placeholder="Search people"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />
          {filteredPeople.map((person) => (
            <ListboxOption key={person.id} value={person}>
              {person.name}
            </ListboxOption>
          ))}
          {filteredPeople.length === 0 && (
            <ListboxEmpty>No results</ListboxEmpty>
          )}
        </ListboxOptions>
      </Listbox>
    </div>
  );
}

```

**src/foundations/ui/listbox/examples/listbox-divider.preview.tsx**

```tsx
"use client";

import { Fragment, useState } from "react";

import {
  Listbox,
  ListboxDivider,
  ListboxOption,
  ListboxOptions,
  ListboxTrigger,
} from "@/foundations/ui/listbox/listbox";

const people = [
  { id: 1, name: "Durward Reynolds" },
  { id: 2, name: "Kenton Towne" },
  { id: 3, name: "Therese Wunsch" },
  { id: 4, name: "Benedict Kessler" },
  { id: 5, name: "Katelyn Rohan" },
];

export default function ListboxDividerPreview() {
  const [selectedPerson, setSelectedPerson] = useState(people[0]);

  return (
    <div className="w-80">
      <Listbox value={selectedPerson} onChange={setSelectedPerson}>
        <ListboxTrigger>{selectedPerson?.name}</ListboxTrigger>
        <ListboxOptions>
          {people.map((person, i) => (
            <Fragment key={person.id}>
              <ListboxOption value={person}>{person.name}</ListboxOption>
              {i === 2 && <ListboxDivider />}
            </Fragment>
          ))}
        </ListboxOptions>
      </Listbox>
    </div>
  );
}

```

**src/foundations/ui/listbox/examples/listbox-minimal.preview.tsx**

```tsx
"use client";

import { useState } from "react";

import {
  Listbox,
  ListboxOption,
  ListboxOptions,
  ListboxTrigger,
} from "@/foundations/ui/listbox/listbox";

const people = [
  { id: 1, name: "Durward Reynolds" },
  { id: 2, name: "Kenton Towne" },
  { id: 3, name: "Therese Wunsch" },
  { id: 4, name: "Benedict Kessler" },
  { id: 5, name: "Katelyn Rohan" },
];

export default function ListboxMinimalPreview() {
  const [selectedPerson, setSelectedPerson] = useState(people[0]);

  return (
    <div className="w-80">
      <Listbox value={selectedPerson} onChange={setSelectedPerson}>
        <ListboxTrigger variant="minimal">
          {selectedPerson?.name}
        </ListboxTrigger>
        <ListboxOptions>
          {people.map((person) => (
            <ListboxOption key={person.id} value={person}>
              {person.name}
            </ListboxOption>
          ))}
        </ListboxOptions>
      </Listbox>
    </div>
  );
}

```

**src/foundations/ui/listbox/examples/listbox-placeholder.preview.tsx**

```tsx
"use client";

import { useState } from "react";

import {
  Listbox,
  ListboxOption,
  ListboxOptions,
  ListboxTrigger,
} from "@/foundations/ui/listbox/listbox";

const people = [
  { id: 1, name: "Durward Reynolds" },
  { id: 2, name: "Kenton Towne" },
  { id: 3, name: "Therese Wunsch" },
  { id: 4, name: "Benedict Kessler" },
  { id: 5, name: "Katelyn Rohan" },
];

export default function ListboxPlaceholderPreview() {
  const [selectedPerson, setSelectedPerson] = useState<
    (typeof people)[number] | null
  >(null);

  return (
    <div className="w-80">
      <Listbox value={selectedPerson} onChange={setSelectedPerson}>
        <ListboxTrigger placeholder="Select person">
          {selectedPerson?.name}
        </ListboxTrigger>
        <ListboxOptions>
          {people.map((person) => (
            <ListboxOption key={person.id} value={person}>
              {person.name}
            </ListboxOption>
          ))}
        </ListboxOptions>
      </Listbox>
    </div>
  );
}

```

**src/foundations/ui/listbox/examples/listbox-custom.preview.tsx**

```tsx
"use client";

import { useState } from "react";

import {
  Avatar,
  AvatarFallback,
  AvatarImage,
} from "@/foundations/ui/avatar/avatar";
import {
  Listbox,
  ListboxOption,
  ListboxOptions,
  ListboxTrigger,
} from "@/foundations/ui/listbox/listbox";

const people = [
  { id: 1, name: "Durward Reynolds" },
  { id: 2, name: "Kenton Towne" },
  { id: 3, name: "Therese Wunsch" },
  { id: 4, name: "Benedict Kessler" },
  { id: 5, name: "Katelyn Rohan" },
];

export default function ListboxCustomPreview() {
  const [selectedPerson, setSelectedPerson] = useState<
    (typeof people)[number] | null
  >(null);

  return (
    <div className="w-80">
      <Listbox value={selectedPerson} onChange={setSelectedPerson}>
        <ListboxTrigger
          placeholder="Select person"
          className={selectedPerson ? "pl-3" : ""}
        >
          {selectedPerson && (
            <span className="flex items-center gap-2">
              <Avatar size="xs">
                <AvatarImage
                  src={`https://api.dicebear.com/6.x/thumbs/svg?seed=${selectedPerson.name}`}
                />
                <AvatarFallback>{selectedPerson.name[0]}</AvatarFallback>
              </Avatar>
              <span>{selectedPerson.name}</span>
            </span>
          )}
        </ListboxTrigger>
        <ListboxOptions>
          {people.map((person) => (
            <ListboxOption
              key={person.id}
              value={person}
              className="flex items-center gap-2 px-3"
            >
              <Avatar size="xs">
                <AvatarImage
                  src={`https://api.dicebear.com/6.x/thumbs/svg?seed=${person.name}`}
                />
                <AvatarFallback>{person.name[0]}</AvatarFallback>
              </Avatar>
              <span>{person.name}</span>
            </ListboxOption>
          ))}
        </ListboxOptions>
      </Listbox>
    </div>
  );
}

```
